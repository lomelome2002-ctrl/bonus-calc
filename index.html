<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>獎勵金作業系統 - 法務部行政執行署</title>
    <style>
        :root { --primary: #1e3a8a; --secondary: #334155; --accent: #be123c; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background-color: #f1f5f9; }
        
        /* 頁籤樣式 */
        .tabs { display: flex; background: var(--primary); padding: 10px 10px 0; gap: 5px; position: sticky; top: 0; z-index: 1000; }
        .tab-btn { padding: 12px 25px; border: none; background: #3b82f6; color: white; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--primary); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* 通用表格與容器樣式 */
        .container { max-width: 1350px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; font-weight: 900; }
        .summary-box { display: flex; justify-content: space-around; background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: right; }
        th { background: var(--secondary); color: white; text-align: center; }
        input { width: 90%; padding: 6px; border: 1px solid #e2e8f0; border-radius: 4px; text-align: center; font-weight: bold; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; margin: 5px; }

        @media print {
            .tabs, .btn, .file-controls, input { display: none !important; }
            .tab-content { display: none !important; }
            .tab-content.active { display: block !important; }
            body { background: white; }
            .container { box-shadow: none; border: none; width: 100%; }
        }
    </style>
</head>
<body>

<nav class="tabs">
    <button class="tab-btn active" onclick="openTab(event, 'tab1')">分署團體獎勵金分配</button>
    <button class="tab-btn" onclick="openTab(event, 'tab2')">主管個人獎勵金核算</button>
</nav>

<div id="tab1" class="tab-content active">
    <div class="container">
        <h2>各分署團體獎勵金數額分配表</h2>
        <div class="summary-box">
            <div>待分配總額 (B): <span style="color:red; font-weight:bold">$2,386,370</span></div>
            <div>剩餘餘額: <span id="t1-rem" style="font-weight:bold">0</span></div>
        </div>
        <div style="text-align:right">
            <button class="btn" style="background:#3b82f6" onclick="window.print()">🖨️ 列印表單</button>
        </div>
        <table id="t1-table">
            <thead>
                <tr>
                    <th rowspan="2">分署</th>
                    <th colspan="3">執行績效+評比名次 (A)</th>
                    <th colspan="3">署長權限分配 (B)</th>
                    <th rowspan="2">總額(A+B)</th>
                </tr>
                <tr style="background:#475569; font-size:0.8em">
                    <th>績效</th><th>名次</th><th>小計A</th>
                    <th>預設</th><th>調整</th><th>小計B</th>
                </tr>
            </thead>
            <tbody id="t1-body"></tbody>
        </table>
    </div>
</div>

<div id="tab2" class="tab-content">
    <div class="container">
        <h2>主管獎勵金任職日數核定參考表</h2>
        <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; gap:20px; align-items:center;">
            <button class="btn" style="background:#f59e0b" onclick="document.getElementById('csvIn').click()">📂 匯入 CSV</button>
            <input type="file" id="csvIn" accept=".csv" style="display:none" onchange="importCSV(event)">
            <button class="btn" style="background:#64748b" onclick="downloadSample()">📝 範本下載</button>
            <label>年度:</label><input type="number" id="t2-year" style="width:80px" value="2026" oninput="calcT2()">
            <button class="btn" style="background:#3b82f6; margin-left:auto" onclick="window.print()">🖨️ 列印表單</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>職稱</th><th>姓名</th><th>上限</th><th>開始日期</th><th>結束日期</th><th>日數</th><th>核算金額</th><th>操作</th>
                </tr>
            </thead>
            <tbody id="t2-body"></tbody>
            <tfoot>
                <tr style="background:#f8fafc; font-weight:bold"><td colspan="6" style="text-align:right">合計：</td><td id="t2-total">0</td><td></td></tr>
            </tfoot>
        </table>
        <button class="btn" style="background:#10b981; margin-top:10px" onclick="addT2Row('', '', 200000)">➕ 手動新增人員</button>
    </div>
</div>

<script>
    // 頁籤切換邏輯
    function openTab(evt, tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    // --- 工具一邏輯 ---
    const t1Data = [
        {n:"台北",p:1747631,r:2,a:2243996},{n:"士林",p:1190195,r:9,a:1509969},{n:"新北",p:2165752,r:5,a:2547571},
        {n:"桃園",p:2073353,r:1,a:2603127},{n:"新竹",p:1265802,r:3,a:1719212},{n:"台中",p:1998116,r:4,a:2394253},
        {n:"彰化",p:816532,r:12,a:1093352},{n:"嘉義",p:883721,r:11,a:1174858},{n:"台南",p:900968,r:13,a:1163469},
        {n:"高雄",p:1689321,r:10,a:1994776},{n:"屏東",p:728757,r:6,a:1096258},{n:"花蓮",p:583540,r:8,a:922405},{n:"宜蘭",p:660902,r:7,a:1014084}
    ];

    function initT1() {
        const body = document.getElementById('t1-body');
        const avg = Math.floor(2386370 / 13);
        const diff = 2386370 - (avg * 13);
        t1Data.forEach((d, i) => {
            const row = document.createElement('tr');
            const vAvg = (i === 12) ? avg + diff : avg;
            row.innerHTML = `
                <td style="text-align:center; font-weight:bold">${d.n}</td>
                <td>${d.p.toLocaleString()}</td>
                <td style="text-align:center">第${d.r}名</td>
                <td style="background:#f8fafc">${d.a.toLocaleString()}</td>
                <td class="t1-avg">${vAvg.toLocaleString()}</td>
                <td><input type="number" class="t1-adj" value="0" oninput="calcT1()"></td>
                <td class="t1-subB" style="color:blue">0</td>
                <td class="t1-final" style="color:red; font-weight:bold">0</td>
            `;
            body.appendChild(row);
        });
        calcT1();
    }

    function calcT1() {
        let sumB = 0;
        document.querySelectorAll('#t1-body tr').forEach((row, i) => {
            const vAvg = parseInt(row.querySelector('.t1-avg').innerText.replace(/,/g,''));
            const vAdj = parseFloat(row.querySelector('.t1-adj').value) || 0;
            const vB = vAvg + vAdj;
            const vFinal = t1Data[i].a + vB;
            row.querySelector('.t1-subB').innerText = vB.toLocaleString();
            row.querySelector('.t1-final').innerText = vFinal.toLocaleString();
            sumB += vB;
        });
        const rem = 2386370 - sumB;
        document.getElementById('t1-rem').innerText = rem.toLocaleString();
        document.getElementById('t1-rem').style.color = rem === 0 ? "green" : "red";
    }

    // --- 工具二邏輯 ---
    function addT2Row(pos, name, cap, s, e) {
        const body = document.getElementById('t2-body');
        const year = document.getElementById('t2-year').value;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" value="${pos}"></td>
            <td><input type="text" value="${name}"></td>
            <td><input type="number" class="t2-cap" value="${cap}" oninput="calcT2()"></td>
            <td><input type="date" class="t2-s" value="${s || year+'-01-01'}" oninput="calcT2()"></td>
            <td><input type="date" class="t2-e" value="${e || year+'-12-31'}" oninput="calcT2()"></td>
            <td class="t2-days">0</td><td class="t2-amt" style="font-weight:bold">0</td>
            <td><button class="btn" style="background:red; padding:2px 5px" onclick="this.parentElement.parentElement.remove(); calcT2();">✕</button></td>
        `;
        body.appendChild(row);
        calcT2();
    }

    function calcT2() {
        const year = parseInt(document.getElementById('t2-year').value);
        const totalDays = ((year % 4 == 0 && year % 100 != 0) || year % 400 == 0) ? 366 : 365;
        let grand = 0;
        document.querySelectorAll('#t2-body tr').forEach(row => {
            const cap = parseFloat(row.querySelector('.t2-cap').value) || 0;
            const start = new Date(row.querySelector('.t2-s').value);
            const end = new Date(row.querySelector('.t2-e').value);
            let d = (end >= start) ? Math.ceil((end - start) / 86400000) + 1 : 0;
            const amt = Math.round(cap * (d / totalDays));
            row.querySelector('.t2-days').innerText = d;
            row.querySelector('.t2-amt').innerText = amt.toLocaleString();
            grand += amt;
        });
        document.getElementById('t2-total').innerText = grand.toLocaleString();
    }

    function downloadSample() {
        const csv = "\uFEFF職稱,姓名,最高上限,開始日期,結束日期\n署長,姓名,200000,2026-01-01,2026-12-31\n台北分署長,接任者A,200000,2026-01-01,2026-05-31\n台北分署長,接任者B,200000,2026-06-01,2026-12-31";
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
        link.download = "主管獎勵金範本.csv";
        link.click();
    }

    function importCSV(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            const lines = ev.target.result.split(/\r?\n/);
            document.getElementById('t2-body').innerHTML = "";
            lines.forEach((l, i) => { if(i>0 && l.trim()) { const p = l.split(","); addT2Row(p[0],p[1],p[2],p[3],p[4]); } });
        };
        reader.readAsText(e.target.files[0], 'UTF-8');
    }

    window.onload = () => { initT1(); addT2Row('署長','',200000); };
</script>
</body>
</html>